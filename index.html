<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FYSM - –ó–∞–ø–∏—Å—å –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</title>
    
    <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è GitHub Pages -->
    <script>
        (function() {
            var redirect = sessionStorage.redirect;
            delete sessionStorage.redirect;
            if (redirect && redirect != location.href) {
                history.replaceState(null, null, redirect);
            }
        })();
    </script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        /* –í–°–¢–†–ê–ò–í–ê–ï–ú –°–¢–ò–õ–ò –í HTML –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .hidden {
            display: none !important;
        }
        
        #appContent {
            display: none;
        }
        
        .balance {
            font-size: 24px;
            margin: 20px 0;
            color: #28a745;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div id="authContent">
            <h1>üí™ FITBOOK</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å–∏ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</p>
            
            <div id="errorMessage" class="error hidden"></div>
            
            <input type="email" id="email" placeholder="Email" class="input">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" class="input">
            
            <button onclick="login()" class="btn">–í–æ–π—Ç–∏</button>
            <button onclick="register()" class="btn btn-secondary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: left;">
                <p><strong>–¢–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:</strong></p>
                <p>üë§ <a href="#" onclick="setTestUser()">user@test.com / 123456</a></p>
                <p>üë®‚Äçüè´ <a href="#" onclick="setTestTrainer()">trainer@test.com / 123456</a></p>
            </div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
        <div id="appContent">
            <h1 id="welcomeMessage">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
            
            <div class="balance">
                –ë–∞–ª–∞–Ω—Å: <span id="balanceAmount">0</span> –±–∞–ª–ª–æ–≤
            </div>
            
            <div id="userRoleInfo" style="margin: 15px 0; padding: 10px; background: #e9ecef; border-radius: 10px;"></div>
            
            <div id="trainerSection" class="hidden">
                <button onclick="createTraining()" class="btn">–°–æ–∑–¥–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
                <button onclick="viewUsers()" class="btn btn-secondary">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</button>
            </div>
            
            <div id="userSection">
                <button onclick="viewSchedule()" class="btn">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</button>
                <button onclick="viewHistory()" class="btn btn-secondary">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π</button>
            </div>
            
            <button onclick="logout()" class="btn" style="background: #dc3545; margin-top: 20px;">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <script>
        // ============================================
        // –ù–ê–°–¢–†–û–ô–ö–ê FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyD5gplXXpP69H0f0WDQehy4jLOOTnw2rZQ",
            authDomain: "fysm-2d26a.firebaseapp.com",
            projectId: "fysm-2d26a",
            storageBucket: "fysm-2d26a.firebasestorage.app",
            messagingSenderId: "1013209595020",
            appId: "1:1013209595020:web:5057a63c94dbf29aa4cfa9"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;
        let userData = null;
        
        // ============================================
        // –§–£–ù–ö–¶–ò–ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
        // ============================================
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }
        
        function setTestUser() {
            document.getElementById('email').value = 'user@test.com';
            document.getElementById('password').value = '123456';
        }
        
        function setTestTrainer() {
            document.getElementById('email').value = 'trainer@test.com';
            document.getElementById('password').value = '123456';
        }
        
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            hideError();
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
            }
        }
        
        async function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            if (password.length < 6) {
                showError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            
            hideError();
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                await db.collection('users').doc(user.uid).set({
                    email: email,
                    name: email.split('@')[0],
                    role: 'user',
                    balance: 100,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ 100 –±–∞–ª–ª–æ–≤.');
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
            }
        }
        
        async function logout() {
            if (confirm('–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
                await auth.signOut();
            }
        }
        
        // ============================================
        // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
        // ============================================
        
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    updateUI();
                } else {
                    // –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º
                    await db.collection('users').doc(currentUser.uid).set({
                        email: currentUser.email,
                        name: currentUser.displayName || currentUser.email.split('@')[0],
                        role: 'user',
                        balance: 100,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    userData = {
                        email: currentUser.email,
                        name: currentUser.displayName || currentUser.email.split('@')[0],
                        role: 'user',
                        balance: 100
                    };
                    
                    updateUI();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            }
        }
        
        function updateUI() {
            if (!userData) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            document.getElementById('welcomeMessage').textContent = `–ü—Ä–∏–≤–µ—Ç, ${userData.name || userData.email}!`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
            document.getElementById('balanceAmount').textContent = userData.balance || 0;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Ç—Ä–µ–Ω–µ—Ä–∞
            if (userData.role === 'trainer') {
                document.getElementById('trainerSection').classList.remove('hidden');
                document.getElementById('userSection').classList.add('hidden');
                document.getElementById('userRoleInfo').textContent = 'üë®‚Äçüè´ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ —Ç—Ä–µ–Ω–µ—Ä';
            } else {
                document.getElementById('trainerSection').classList.add('hidden');
                document.getElementById('userSection').classList.remove('hidden');
                document.getElementById('userRoleInfo').textContent = 'üë§ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            }
        }
        
        // ============================================
        // –§–£–ù–ö–¶–ò–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // ============================================
        
        async function createTraining() {
            const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:');
            if (!title) return;
            
            const dateStr = prompt('–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è (—Ñ–æ—Ä–º–∞—Ç: –ì–ì–ì–ì-–ú–ú-–î–î –ß–ß:–ú–ú, –Ω–∞–ø—Ä–∏–º–µ—Ä: 2024-01-20 19:00):');
            if (!dateStr) return;
            
            const price = prompt('–°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –±–∞–ª–ª–∞—Ö:');
            if (!price || isNaN(price)) {
                alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ');
                return;
            }
            
            try {
                const date = new Date(dateStr.replace(' ', 'T'));
                
                await db.collection('trainings').add({
                    title: title,
                    date: firebase.firestore.Timestamp.fromDate(date),
                    price: parseInt(price),
                    trainerId: currentUser.uid,
                    trainerName: userData.name,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!');
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function viewSchedule() {
            try {
                const querySnapshot = await db.collection('trainings')
                    .where('date', '>=', firebase.firestore.Timestamp.now())
                    .orderBy('date')
                    .limit(10)
                    .get();
                
                if (querySnapshot.empty) {
                    alert('–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫');
                    return;
                }
                
                let message = 'üìÖ –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:\n\n';
                
                querySnapshot.forEach(doc => {
                    const training = doc.data();
                    const date = training.date.toDate();
                    message += `üèãÔ∏è ${training.title}\n`;
                    message += `üìÖ ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}\n`;
                    message += `üí∞ ${training.price} –±–∞–ª–ª–æ–≤\n`;
                    message += `üë®‚Äçüè´ ${training.trainerName || '–¢—Ä–µ–Ω–µ—Ä'}\n`;
                    
                    if (userData.balance >= training.price) {
                        message += `‚úÖ <a href="#" onclick="registerForTraining('${doc.id}', ${training.price})">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</a>\n`;
                    } else {
                        message += `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤\n`;
                    }
                    
                    message += `---\n`;
                });
                
                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 20px;
                    border-radius: 15px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                
                modalContent.innerHTML = `
                    <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
                    <div style="white-space: pre-line;">${message}</div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: #667eea;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 10px;
                        margin-top: 15px;
                        cursor: pointer;
                    ">–ó–∞–∫—Ä—ã—Ç—å</button>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: ' + error.message);
            }
        }
        
        async function registerForTraining(trainingId, price) {
            if (!confirm(`–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –∑–∞ ${price} –±–∞–ª–ª–æ–≤?`)) return;
            
            try {
                await db.runTransaction(async (transaction) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
                    const userRef = db.collection('users').doc(currentUser.uid);
                    const userDoc = await transaction.get(userRef);
                    const currentBalance = userDoc.data().balance;
                    
                    if (currentBalance < price) {
                        throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤');
                    }
                    
                    // –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã
                    transaction.update(userRef, {
                        balance: currentBalance - price
                    });
                    
                    // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    const regRef = db.collection('registrations').doc();
                    transaction.set(regRef, {
                        userId: currentUser.uid,
                        trainingId: trainingId,
                        willAttend: true,
                        charged: true,
                        registeredAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                    const transRef = db.collection('transactions').doc();
                    transaction.set(transRef, {
                        userId: currentUser.uid,
                        trainingId: trainingId,
                        amount: price,
                        type: 'debit',
                        description: '–ó–∞–ø–∏—Å—å –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                alert('‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã!');
                loadUserData(); // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        function viewUsers() {
            alert('–§—É–Ω–∫—Ü–∏—è "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function viewHistory() {
            alert('–§—É–Ω–∫—Ü–∏—è "–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        // ============================================
        // –°–õ–£–®–ê–¢–ï–õ–¨ –°–û–°–¢–û–Ø–ù–ò–Ø –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
        // ============================================
        
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω—ã
                document.getElementById('authContent').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
            } else {
                currentUser = null;
                userData = null;
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω—ã
                document.getElementById('authContent').style.display = 'block';
                document.getElementById('appContent').style.display = 'none';
                hideError();
            }
        });
        
        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ email
            document.getElementById('email')?.focus();
        });
    </script>
</body>
</html>
